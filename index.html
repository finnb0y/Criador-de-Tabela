<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coleta de Dados de Clones</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts link is now in style.css via @import -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Sistema de Coleta de Dados de Clones</h1>
            <p>Interface intuitiva para coleta e exporta√ß√£o de dados experimentais</p>
        </div>

        <div class="main-content">
            <!-- Configura√ß√µes Iniciais -->
            <div class="form-section">
                <div class="form-group">
                    <h3>Configura√ß√µes do Arquivo</h3>
                    <div class="input-row">
                        <label for="nomeArquivo">Nome do Arquivo:</label>
                        <input type="text" id="nomeArquivo" placeholder="Ex: experimento_2024">
                    </div>
                </div>

                <div class="form-group">
                    <h3>Dados do Experimento</h3>
                    <div class="input-row">
                        <label for="ano">Ano (AAAA ou AA):</label>
                        <input type="text" id="ano" placeholder="Ex: 2024 ou 24" maxlength="4">
                    </div>
                    <div class="input-row">
                        <label for="pais">C√≥digo dos Pais:</label>
                        <input type="text" id="pais" placeholder="Ex: 01" maxlength="2">
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Adi√ß√£o de Clones -->
            <div class="clone-section">
                <h4>‚ûï Adicionar Novo Clone</h4>
                <div class="input-row">
                    <label for="numeroClone">N√∫mero do Clone:</label>
                    <input type="text" id="numeroClone" placeholder="Ex: 001">
                    <button class="btn btn-primary" onclick="adicionarClone()">Adicionar Clone</button>
                </div>
            </div>

            <!-- Planilha de Dados -->
            <div class="spreadsheet-container" id="spreadsheetContainer" style="display: none;">
                <div class="spreadsheet-header">
                    <h3>üìä Planilha de Dados em Tempo Real</h3>
                    <p>Clique em qualquer c√©lula para editar os valores</p>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Clones</th>
                            <th>Rep</th>
                            <th>Peso g (casca+raiz)</th>
                            <th>Nematoides totais</th>
                            <th>Nema/g</th>
                            <th>FR</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>

            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- Bot√µes Flutuantes -->
    <div class="floating-buttons">
        <button class="fab btn-theme-toggle" onclick="toggleTheme()" title="Alternar Tema" id="themeToggleBtn">‚òÄÔ∏è</button>
        <button class="fab btn-success" onclick="exportarExcel()" title="Exportar Excel">üì•</button>
        <button class="fab btn-primary" onclick="limparDados()" title="Limpar Dados">üóëÔ∏è</button>
    </div>

    <script>
        let dados = [];
        let editingCell = null;
        let currentModal = null; // Keep track of the current modal

        // --- THEME TOGGLE ---
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

        function applyTheme(theme) {
            if (theme === "dark") {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggleBtn.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeToggleBtn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || (prefersDarkScheme.matches ? 'dark' : 'light');
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // Load saved theme or system preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme(prefersDarkScheme.matches ? 'dark' : 'light');
        }
        // --- END THEME TOGGLE ---


        function formatarPeso(pesoStr) {
            if (!pesoStr) return null;
            
            pesoStr = pesoStr.trim();
            
            if (pesoStr.includes(',') || pesoStr.includes('.')) {
                try {
                    const peso = parseFloat(pesoStr.replace(',', '.'));
                    return isNaN(peso) ? null : peso;
                } catch {
                    return null;
                }
            }
            
            if (pesoStr.match(/^\d+$/)) {
                const numero = parseInt(pesoStr);
                if (numero > 999) {
                    return numero / 100.0;
                } else {
                    return numero;
                }
            }
            
            return null;
        }

        function gerarCodigoCompleto() {
            const ano = document.getElementById('ano').value.trim();
            const pais = document.getElementById('pais').value.trim();
            
            if (!ano || !pais) {
                mostrarMensagem('Por favor, preencha o ano e c√≥digo dos pais primeiro.', 'error');
                return null;
            }

            const anoFinal = ano.length === 4 ? ano.slice(-2) : ano;
            
            if (anoFinal.length !== 2 || !anoFinal.match(/^\d{2}$/)) {
                mostrarMensagem('Formato de ano inv√°lido.', 'error');
                return null;
            }

            if (pais.length !== 2 || !pais.match(/^\d{2}$/)) {
                mostrarMensagem('Formato de c√≥digo dos pais inv√°lido.', 'error');
                return null;
            }

            return anoFinal + pais;
        }

        function adicionarClone() {
            const codigoBase = gerarCodigoCompleto();
            if (!codigoBase) return;

            const numeroClone = document.getElementById('numeroClone').value.trim();
            if (!numeroClone) {
                mostrarMensagem('Por favor, digite o n√∫mero do clone.', 'error');
                return;
            }

            const codigoCompleto = codigoBase + numeroClone;
            criarModalEntradaDados(codigoCompleto);
        }
        
        // Handler for ESC key on modal
        function handleModalEsc(event) {
            if (event.key === 'Escape') {
                if (currentModal) {
                    currentModal.remove();
                    currentModal = null;
                    document.removeEventListener('keydown', handleModalEsc);
                }
            }
        }

        function criarModalEntradaDados(codigoCompleto) {
            if (currentModal) currentModal.remove(); // Remove any existing modal

            const modal = document.createElement('div');
            currentModal = modal; // Set current modal

            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center;
                justify-content: center; z-index: 2000; padding: 20px;
                box-sizing: border-box; overflow-y: auto;
            `;

            // Use class for modal content styling from CSS
            modal.innerHTML = `
                <div class="modal-content"> 
                    <h3>
                        üìù Dados para Clone: ${codigoCompleto}
                    </h3>
                    
                    <div style="margin-bottom: 25px;">
                        <h4>‚öñÔ∏è Pesos (g):</h4>
                        <div class="data-grid">
                            <input type="text" id="peso1" placeholder="Rep 1" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="peso2" placeholder="Rep 2" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="peso3" placeholder="Rep 3" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="peso4" placeholder="Rep 4" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4>ü¶† Nematoides Totais:</h4>
                        <div class="data-grid">
                            <input type="text" id="nema1" placeholder="Rep 1" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="nema2" placeholder="Rep 2" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="nema3" placeholder="Rep 3" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                            <input type="text" id="nema4" placeholder="Rep 4" class="data-input" style="padding: 12px 8px; font-size: 0.9rem;">
                        </div>
                    </div>

                    <div style="text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="salvarDadosClone('${codigoCompleto}')" style="padding: 12px 20px; font-size: 0.95rem;">
                            ‚úÖ Salvar
                        </button>
                        <button class="btn" style="background: #6c757d; color: white; padding: 12px 20px; font-size: 0.95rem;" onclick="this.closest('.modal-content').parentElement.remove(); currentModal = null; document.removeEventListener('keydown', handleModalEsc);">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.addEventListener('keydown', handleModalEsc); // Add ESC listener

            const modalInputs = modal.querySelectorAll('input');
            modalInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        salvarDadosClone(codigoCompleto);
                    }
                });
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) { // Clicked on the backdrop
                    modal.remove();
                    currentModal = null;
                    document.removeEventListener('keydown', handleModalEsc);
                }
            });
        }

        function salvarDadosClone(codigoCompleto) {
            if (!currentModal) return; // Ensure modal exists

            const pesos = [
                currentModal.querySelector('#peso1').value,
                currentModal.querySelector('#peso2').value,
                currentModal.querySelector('#peso3').value,
                currentModal.querySelector('#peso4').value
            ];

            const nematoides = [
                currentModal.querySelector('#nema1').value,
                currentModal.querySelector('#nema2').value,
                currentModal.querySelector('#nema3').value,
                currentModal.querySelector('#nema4').value
            ];

            for (let i = 0; i < 4; i++) {
                const peso = formatarPeso(pesos[i]);
                const nema = nematoides[i] && nematoides[i].match(/^\d+$/) ? parseInt(nematoides[i]) : null;
                
                dados.push({
                    clone: codigoCompleto,
                    rep: i + 1,
                    peso: peso,
                    nematoides: nema,
                    nemaG: null,
                    fr: null
                });
            }

            atualizarTabela();
            currentModal.remove();
            currentModal = null;
            document.removeEventListener('keydown', handleModalEsc); // Clean up listener
            document.getElementById('numeroClone').value = '';
            mostrarMensagem(`Clone ${codigoCompleto} adicionado com sucesso!`, 'success');
        }

        function atualizarTabela() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            dados.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.clone}</td>
                    <td>${item.rep}</td>
                    <td class="editable" onclick="editarCelula(this, ${index}, 'peso')">${item.peso !== null ? item.peso : ''}</td>
                    <td class="editable" onclick="editarCelula(this, ${index}, 'nematoides')">${item.nematoides !== null ? item.nematoides : ''}</td>
                    <td>${item.nemaG !== null ? item.nemaG : ''}</td>
                    <td>${item.fr !== null ? item.fr : ''}</td>
                `;
            });

            document.getElementById('spreadsheetContainer').style.display = dados.length > 0 ? 'block' : 'none';
        }

        function editarCelula(cell, index, campo) {
            if (editingCell) return;

            editingCell = cell;
            const valorAtual = dados[index][campo];
            
            const input = document.createElement('input');
            input.className = 'edit-input';
            input.value = valorAtual !== null ? valorAtual : '';
            input.type = campo === 'nematoides' ? 'number' : 'text';

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            function finalizarEdicao() {
                if (!editingCell) return; // Avoid issues if already finalized
                let novoValor = input.value.trim();
                
                if (campo === 'peso') {
                    novoValor = formatarPeso(novoValor);
                } else if (campo === 'nematoides') {
                    novoValor = novoValor && novoValor.match(/^\d+$/) ? parseInt(novoValor) : null;
                }

                dados[index][campo] = novoValor;
                cell.innerHTML = novoValor !== null ? novoValor : '';
                editingCell = null;
                input.removeEventListener('blur', finalizarEdicao); // Clean up
                input.removeEventListener('keypress', handleEditKeyPress); // Clean up
            }

            function handleEditKeyPress(e) {
                if (e.key === 'Enter') {
                    finalizarEdicao();
                } else if (e.key === 'Escape') { // Allow Esc to cancel edit
                    cell.innerHTML = valorAtual !== null ? valorAtual : '';
                    editingCell = null;
                    input.removeEventListener('blur', finalizarEdicao);
                    input.removeEventListener('keypress', handleEditKeyPress);
                }
            }

            input.addEventListener('blur', finalizarEdicao);
            input.addEventListener('keypress', handleEditKeyPress);
        }

        function exportarExcel() {
            if (dados.length === 0) {
                mostrarMensagem('Nenhum dado para exportar.', 'error');
                return;
            }

            const nomeArquivo = document.getElementById('nomeArquivo').value.trim() || 'dados_clones';
            
            const dadosExportacao = [
                ['Clones', 'Rep', 'Peso g (casca+raiz)', 'Nematoides totais', 'Nema/g', 'FR']
            ];

            dados.forEach(item => {
                dadosExportacao.push([
                    item.clone,
                    item.rep,
                    item.peso,
                    item.nematoides,
                    item.nemaG,
                    item.fr
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dadosExportacao);

            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[address]) continue;
                ws[address].s = {
                    font: { bold: true, color: { rgb: "FFFFFFFF" } }, // White text
                    fill: { fgColor: { rgb: "FF4facfe" } }, // Blue background
                    alignment: { horizontal: 'center' }
                };
            }
            // Style for dark theme compatibility
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                 for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[address]) continue;
                    ws[address].s.fill.fgColor.rgb = "FF9055A2"; // Purpureus
                    ws[address].s.font.color.rgb = "FF011638"; // Oxford Blue text
                 }
            }


            const colWidths = [
                { wch: 15 }, { wch: 8 }, { wch: 20 }, { wch: 18 }, { wch: 12 }, { wch: 8 }
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            XLSX.writeFile(wb, `${nomeArquivo.replace(/\s+/g, '_')}.xlsx`);

            mostrarMensagem('Arquivo Excel exportado com sucesso!', 'success');
        }

        function limparDados() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                dados = [];
                atualizarTabela();
                mostrarMensagem('Dados limpos com sucesso!', 'success');
            }
        }

        function mostrarMensagem(texto, tipo) {
            const container = document.getElementById('statusMessage');
            container.innerHTML = `<div class="status-message ${tipo}">${texto}</div>`;
            
            setTimeout(() => {
                if (container.firstChild && container.firstChild.textContent === texto) { // Only clear if it's the same message
                    container.innerHTML = '';
                }
            }, 4000);
        }

        document.getElementById('ano').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById('pais').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById('numeroClone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adicionarClone();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            mostrarMensagem('üöÄ Sistema iniciado! Preencha as configura√ß√µes e comece a adicionar clones.', 'success');
        });
    </script>
</body>
</html>
